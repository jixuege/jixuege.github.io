---
layout: post
title: CI持续集成系列之（七）使用jenkins实现代码部署
date: 2016-8-16
categories: blog
tags: [持续集成构建发布系列]
description: 利用jenkins来做代码部署
---

# 前言
前篇已经实现了拉取代码到Jenkins，代码的质量检测，下一步就是把检测后的代码部署到测试机了。
可以理解为，我有2个项目，1个项目用来做代码检测(项目名为web-demo)，1个项目用来发布(demo-deploy)。这样我可以单独使用任何一个项目，也可以把两个项目并起来使用。关联的作用就是如果代码质量检测有问题那么我就不会去发布。

# 具体操作
如何去实现代码发布呢？最简单的方法就是使用脚本来进行这系列操作。这里使用普通用户www来进行发布。

* 建立www用户，用来启动web服务和代码发布：
<pre>
# useradd www
# echo "www"|passwd --stdin www
# su - www
$ ssh-keygen  -t rsa
$ cd .ssh
$ cat id_rsa.pub 
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDUn+KHKrEoKZsnpI+z7aoswnzTaONy+re9IF2bmhcD9v3VzxhJyYmCjDG4aTWhLdyETM4WUAqjnnbn8v6kOn5gcO/XFceBi6dbOFz3yhUE6wDJn/qLOU5ck0RS5ThBAVSCzsjCyczRgU8GrJaeO96/SZRYbiAMWS6BVFafQGucB0qYHMOJJnHXu3y6BMLrNA8ISXt3xH9RVf6J8g3XGtt90jF9AWagl6PErp2zg3Log0w92JhtwKlgEMIBtnS4NOU5GSyCOxN0OxMwdz2gufWSmL1wLcIagEBCCBlV/bvK56pRjli1Om977KT+O4MextSeCxrIi2aubc6mefpj6+HV www@jenkins-101

</pre>
将www用户的公钥添加到gitlab项目的key，这样www用户可获取代码。

* 新建项目，项目名为demo-deploy，用来发布代码
![代码发布](http://7xwp9m.com1.z0.glb.clouddn.com/五-代码发布公钥配置.jpg_jixuege)
验证www用户是否可以拉取代码
<pre>
[www@jenkins-101 .ssh]$ git clone git@10.0.0.102:root/web-demo.git
正克隆到 'web-demo'...
remote: Counting objects: 3, done.
remote: Total 3 (delta 0), reused 0 (delta 0)
接收对象中: 100% (3/3), done.
[www@jenkins-101 .ssh]$ ll
总用量 16
-rw------- 1 www www  396 8月  29 12:46 authorized_keys
-rw------- 1 www www 1679 8月  29 12:43 id_rsa
-rw-r--r-- 1 www www  397 8月  29 12:43 id_rsa.pub
-rw-r--r-- 1 www www  344 8月  29 12:47 known_hosts
drwxrwxr-x 3 www www   33 8月  29 12:49 web-demo
</pre>

这里有个问题，就是发布代码使用脚本，但是脚本是用www用户来执行，但是jenkins默认是使用jenkins用户来执行构建项目。解决办法就是通过jenkins用户ssh到www用户来执行部署脚本。那么这里就涉及到了一个认证的问题。

（未完，待续）